import React from 'react';
import { Formik } from 'formik';
import * as Yup from 'yup';

export default React.forwardRef((props, ref) => {
  const { children, initialValues = {}, onSubmit = (d) => console.log(d), validationSchema = Yup.object().shape({}) } = props;

  // get list of field names
  const fields = children.filter((c) => c && c.props && c.props.name).map((c) => c.props.name);
  const dateFields = children
    .filter((c) => c && c.props && c.props.inputType && (c.props.inputType === 'date' || c.props.inputType === 'datetime'))
    .map((c) => c.props.name);

  // ensure an initial value is provided for each field
  fields.forEach((fieldName) => {
    if (!initialValues[fieldName]) {
      if (dateFields.includes(fieldName)) {
        initialValues[fieldName] = new Date();
      } else {
        initialValues[fieldName] = '';
      }
    }
  });
  // ensure that the validationSchema does not contain validation for non-existent fields, causing submit to fail
  if (validationSchema && validationSchema.fields) {
    const missingValidatedFields = Object.keys(validationSchema.fields).filter((f) => !fields.includes(f));
    if (missingValidatedFields.length) {
      console.warn(
        `Validating field(s) '${missingValidatedFields.join(', ')}', but no Input is present in the form. It will fail to submit`,
      );
    }
  }

  return (
    <Formik innerRef={ref} initialValues={initialValues} validationSchema={validationSchema} onSubmit={onSubmit}>
      {() => <React.Fragment>{children}</React.Fragment>}
    </Formik>
  );
});
