import React from 'react';
import { Button, Text } from 'react-native';
import { KeyboardAwareScrollView } from 'react-native-keyboard-aware-scroll-view';
import { connect } from 'react-redux';

import LoginActions from './login.reducer';
import { useDidUpdateEffect } from '../../shared/util/use-did-update-effect';
import styles from './login-screen.styles';

function LoginScreen(props) {
  const { navigation, account, fetching, error, attemptLogin } = props;
  // setup error state for displaying error messages
  const [loginError, setLoginError] = React.useState('');

  // if the user is already logged in, send them home
  React.useEffect(() => {
    if (account !== null) {
      navigation.navigate('Home');
    }
  }, [account, navigation]);

  // skip the first render but check for API responses and show error if not fetching
  useDidUpdateEffect(() => {
    if (!fetching && error) {
      setLoginError(error);
    }
  }, [fetching]);

  return (
    <KeyboardAwareScrollView contentContainerStyle={styles.container} keyboardShouldPersistTaps="handled" keyboardDismissMode="on-drag">
        <Text style={styles.errorText}>{loginError}</Text>
        <Button title={'Login'} onPress={attemptLogin} />
    </KeyboardAwareScrollView>
  );
}

const mapStateToProps = (state) => {
  return {
    account: state.account.account,
    fetching: state.login.fetching,
    error: state.login.error,
  };
};

const mapDispatchToProps = (dispatch) => {
  return {
    attemptLogin: () => dispatch(LoginActions.loginRequest()),
  };
};

export default connect(mapStateToProps, mapDispatchToProps)(LoginScreen);
