import * as React from 'react';
import { Text, useWindowDimensions, View } from 'react-native';
import { createDrawerNavigator } from '@react-navigation/drawer';
import { connect } from 'react-redux';

// import screens
import LaunchScreen from '../modules/home/launch-screen';
import LoginScreen from '../modules/login/login-screen';
import SettingsScreen from '../modules/account/settings/settings-screen';
import RegisterScreen from '../modules/account/register/register-screen';
import ForgotPasswordScreen from '../modules/account/password-reset/forgot-password-screen';
import ChangePasswordScreen from '../modules/account/password/change-password-screen';
import EntityStackScreen from './entity-stack';
import StorybookScreen from '../../storybook';
<%_ if (websocket) { _%>
import ChatScreen from '../modules/chat/chat-screen'
<%_ } _%>
import DrawerContent from './drawer/drawer-content';
import * as Linking from 'expo-linking';
import { createStackNavigator } from '@react-navigation/stack';
import { isReadyRef, navigationRef } from './nav-ref';
import { useReduxDevToolsExtension } from '@react-navigation/devtools';
import NotFound from '../../NotFound';
import { NavigationContainer } from '@react-navigation/native';
import { getEntityRoutes } from './entity.stack';

export const drawerScreens = [
  {
    name: 'Home',
    component: LaunchScreen,
    auth: null,
  },
  {
    name: 'Login',
    route: 'login',
    component: LoginScreen,
    auth: false,
  },
  {
    name: 'Settings',
    route: 'settings',
    component: SettingsScreen,
    auth: true,
  },
  {
    name: 'Register',
    route: 'register',
    component: RegisterScreen,
    auth: false,
  },
  {
    name: 'Forgot Password',
    route: 'reset-password',
    component: ForgotPasswordScreen,
    auth: false,
  },
  {
    name: 'Change Password',
    route: 'change-password',
    component: ChangePasswordScreen,
    auth: true,
  },
  {
    name: 'Entities',
    isStack: true,
    component: EntityStackScreen,
    options: {
      headerShown: false,
    },
    auth: true,
  },
  {
    name: 'Storybook',
    route: 'storybook',
    component: StorybookScreen,
    auth: null,
  },
  <%_ if (websocket) { _%>
  {
    name: 'Chat',
    route: 'chat',
    component: ChatScreen,
  },
  <%_ } _%>
];

export const getDrawerRoutes = () => {
  const routes = {};
  drawerScreens.forEach((screen) => {
    if (screen.route) {
      routes[screen.name] = screen.route;
    }
  });
  return routes;
};

const linking = {
  prefixes: ['rnapp://', Linking.makeUrl('/')],
  config: {
    initialRouteName: 'Home',
    screens: {
      Home: {
        screens: {
          ...getDrawerRoutes(),
          Entities: {
            path: 'entities',
            screens: {
              EntityStack: '',
              ...getEntityRoutes(),
            },
          },
        },
      },
      ModalScreen: 'alert',
      NotFound: '*',
    },
  },
};

const Stack = createStackNavigator();
const Drawer = createDrawerNavigator();

const getScreens = (props) => {
  const isAuthed = props.account !== null;
  return drawerScreens.map((screen, index) => {
    if (screen.auth === null || screen.auth === undefined) {
      return <Drawer.Screen name={screen.name} component={screen.component} options={screen.options || {}} key={index} />;
    } else if (screen.auth === isAuthed) {
      return <Drawer.Screen name={screen.name} component={screen.component} options={screen.options || {}} key={index} />;
    }
    return null;
  });
};

function NavContainer(props) {
  React.useEffect(() => {
    return () => {
      isReadyRef.current = false;
    };
  }, []);
  useReduxDevToolsExtension(navigationRef);

  const dimensions = useWindowDimensions();
  const { loaded } = props;
  return !loaded ? (
    <View>
      <Text>Loading...</Text>
    </View>
  ) : (
    <NavigationContainer
      linking={linking}
      ref={navigationRef}
      onReady={() => {
        isReadyRef.current = true;
      }}>
      <Stack.Navigator>
        <Stack.Screen name="Home" options={{ headerShown: false }}>
          {() => (
            <Drawer.Navigator
              drawerContent={(p) => <DrawerContent {...p} />}
              initialRouteName={drawerScreens[0].name}
              drawerType={dimensions.width >= 768 ? 'permanent' : 'front'}
              screenOptions={{ headerShown: true }}>
              {getScreens(props)}
            </Drawer.Navigator>
          )}
        </Stack.Screen>
        <Stack.Screen name="NotFound" component={NotFound} options={{ title: 'Oops!' }} />
      </Stack.Navigator>
    </NavigationContainer>
  );
}

const mapStateToProps = (state) => {
  return {
    loaded: state.appState.rehydrationComplete,
    account: state.account.account,
  };
};

const mapDispatchToProps = (dispatch) => {
  return {};
};

export default connect(mapStateToProps, mapDispatchToProps)(NavContainer);
